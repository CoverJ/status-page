---
/**
 * Status page route for subdomain-based routing.
 * This page is rendered when accessing {subdomain}.downtime.online
 *
 * Note: The subdomain routing is handled by middleware (src/middleware.ts)
 * which resolves the Page data from the database.
 */
export const prerender = false;

import type { PageStatusIndicator } from "@/db/schema/constants";
import StatusPageLayout from "@/layouts/StatusPageLayout.astro";
import { createDb } from "@/db/client";
import { ComponentRepository, ComponentGroupRepository } from "@/db/repositories";
import { ComponentList, type GroupWithComponents, type ComponentWithUptime } from "@/components/status";

// Get the subdomain route info from middleware
const subdomainRoute = Astro.locals.subdomainRoute;

// This page should only be rendered for status-page routes
// Redirect to 404 if not a valid status page
if (subdomainRoute.type !== "status-page") {
	return Astro.redirect("/404");
}

const { page } = subdomainRoute;
const statusIndicator = (page.statusIndicator || "none") as PageStatusIndicator;

// Fetch components and groups from the database
const db = createDb(Astro.locals.runtime.env.DB);
const [components, groups] = await Promise.all([
	ComponentRepository.findByPageId(db, page.pageId),
	ComponentGroupRepository.findByPageId(db, page.pageId),
]);

// Add placeholder uptime for showcased components (MVP - real calculation in future)
const componentsWithUptime: ComponentWithUptime[] = components.map((c) => ({
	...c,
	// Placeholder: 99.9% uptime for showcased components
	// TODO: Calculate real uptime from incident history (DT-025 tech note)
	uptimePercentage: c.showcase ? 99.9 : undefined,
}));

// Organize components by groups
const groupsWithComponents: GroupWithComponents[] = groups.map((group) => ({
	group,
	components: componentsWithUptime.filter((c) => c.groupId === group.groupId),
}));

// Get ungrouped components (components with no group assigned)
const ungroupedComponents = componentsWithUptime.filter((c) => !c.groupId);
---

<StatusPageLayout
	pageName={page.name}
	statusIndicator={statusIndicator}
	statusDescription={page.statusDescription}
	subscribeUrl="/subscribe"
>
	<section class="space-y-6">
		<!-- Component Status Section -->
		<div>
			<h2 class="mb-4 text-lg font-semibold text-foreground">
				System Components
			</h2>
			<ComponentList
				client:load
				groups={groupsWithComponents}
				ungroupedComponents={ungroupedComponents}
			/>
		</div>

		<!-- Active Incidents Section - Placeholder for DT-026 -->
		<div class="rounded-lg border border-border bg-card p-6 shadow-sm">
			<h2 class="mb-4 text-lg font-semibold text-foreground">
				Active Incidents
			</h2>
			<p class="text-muted-foreground">
				No active incidents reported.
			</p>
		</div>

		<!-- Past Incidents Section - Placeholder -->
		<div class="space-y-4">
			<h2 class="text-lg font-semibold text-foreground">
				Past Incidents
			</h2>
			<p class="text-sm text-muted-foreground">
				Incident history will be displayed here.
			</p>
		</div>
	</section>
</StatusPageLayout>

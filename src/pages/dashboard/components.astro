---
import type {
	ComponentData,
	ComponentGroupData,
} from "@/components/dashboard/ComponentList";
import ComponentList from "@/components/dashboard/ComponentList";
import type { StatusPage, User } from "@/components/dashboard/DashboardSidebar";
import DashboardLayout from "@/layouts/DashboardLayout.astro";

// Dashboard pages must be server-rendered for auth
export const prerender = false;

// TODO: Replace with actual auth/session data from DT-007
const mockUser: User = {
	id: "user_1",
	email: "admin@example.com",
	name: "Admin User",
};

const mockPages: StatusPage[] = [
	{
		id: "page_1",
		name: "Acme Corp",
		subdomain: "acme",
	},
	{
		id: "page_2",
		name: "Widget Inc",
		subdomain: "widget",
	},
];

const pageId = Astro.url.searchParams.get("page") || mockPages[0].id;
const currentPage = mockPages.find((p) => p.id === pageId) || mockPages[0];

// TODO: Replace with actual database queries from repositories
// Mock data for demonstration - will be replaced with real DB queries
const mockGroups: ComponentGroupData[] = [
	{
		groupId: "group_1",
		name: "Core Infrastructure",
		position: 0,
	},
	{
		groupId: "group_2",
		name: "API Services",
		position: 1,
	},
];

const mockComponents: ComponentData[] = [
	{
		componentId: "comp_1",
		name: "Web Application",
		description: "Main customer-facing web application",
		status: "operational",
		groupId: "group_1",
		position: 0,
	},
	{
		componentId: "comp_2",
		name: "Database Cluster",
		description: "Primary PostgreSQL database cluster",
		status: "operational",
		groupId: "group_1",
		position: 1,
	},
	{
		componentId: "comp_3",
		name: "REST API",
		description: "Public REST API endpoints",
		status: "degraded_performance",
		groupId: "group_2",
		position: 0,
	},
	{
		componentId: "comp_4",
		name: "GraphQL API",
		description: "GraphQL API service",
		status: "operational",
		groupId: "group_2",
		position: 1,
	},
	{
		componentId: "comp_5",
		name: "Email Service",
		description: "Transactional email delivery",
		status: "under_maintenance",
		groupId: null,
		position: 0,
	},
];

// For empty state testing, uncomment the following:
// const mockGroups: ComponentGroupData[] = [];
// const mockComponents: ComponentData[] = [];
---

<DashboardLayout
	title="Components"
	user={mockUser}
	pages={mockPages}
	currentPage={currentPage}
>
	<div class="space-y-8">
		<div>
			<h1 class="text-3xl font-bold tracking-tight">Components</h1>
			<p class="text-muted-foreground mt-2">
				Manage the components displayed on your status page.
			</p>
		</div>

		<ComponentList
			client:load
			components={mockComponents}
			groups={mockGroups}
		/>
	</div>
</DashboardLayout>

<script>
	// Handle component status changes
	// This will be connected to actual API endpoints in DT-013
	document.addEventListener('astro:page-load', () => {
		// Future: Add event listeners for status change callbacks
		// The ComponentList component will call onStatusChange which we can handle here
		// to make API calls to update component status
	});
</script>
